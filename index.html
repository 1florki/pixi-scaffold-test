<!doctype html>
<meta charset="utf-8">
<title>pixi scaffold</title>

<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">

<body style="background-color:black; margin: 0; height: 100%; overflow: hidden">

  <script src="./helper/helper.js"></script>
  <script src="./helper/engine.js"></script>


  <script>
    class SnakeGame {
      constructor(opts) {
        opts = opts || {};
        this.gridX = 15;
        this.gridY = 30;
        this.cellSize = 20;

        this.w = this.gridX * this.cellSize + 60;
        this.h = this.gridY * this.cellSize + 40;
        
        this.centerZero = true
      }

      setup(px) {
        this.px = px;
        
        px.removeAll();
        
        px.createShape({
          w: px.w,
          h: px.h,
          color: 0xffffff,
          alpha: 0.1
        })
        
        // draw grid
        for (let x = 0; x < this.gridX; x++) {
          for (let y = 0; y < this.gridY; y++) {
            let s = px.createShape({
              s: this.cellSize,
              strokeWeight: 1.2,
              stroke: 0xffffff,
            });
            this.setPosition(s, x, y);
          }
        }
        
        this.dir = new Vector(1, 0);
        this.newDir = new Vector(1, 0);
        
        this.snakeItems = [];
        this.snake = [new Vector(Math.floor(this.gridX / 2), Math.floor(this.gridY / 2))];
        this.updateSnake();
        
        this.grow = 3;
        
        
        this.foodItem = px.createShape({s: this.cellSize + 1, color: 0xff0000});
        this.placeFood(px);
        
        this.scoreItem = px.createShape({y: this.h / 2 - 20, x: this.w / 2 - 5, text: "0", textColor: 0xffffff, textAlign: "right"})
      }
      
      updateSnake() {
        while(this.snakeItems.length < this.snake.length) {
          this.snakeItems.push(this.px.createShape({s: this.cellSize, color: 0x00ffff, alpha: 1, stroke: 0}));
        }
        
        for(let i = 0; i < this.snake.length && i < this.snakeItems.length; i++) {
          this.setPosition(this.snakeItems[i], this.snake[i].x, this.snake[i].y);
        }
      }
      
      setPosition(item, x, y) {
        item.x = x * this.cellSize + this.cellSize / 2 - this.w / 2 + 20;
        item.y = y * this.cellSize + this.cellSize / 2 - this.h / 2 + 20;
      }
      
      placeFood() {
        this.food = new Vector(Math.floor(this.px.random(this.gridX)), Math.floor(this.px.random(this.gridY)));
        
        for(let s of this.snake) {
          if(s.x == this.food.x && s.y == this.food.y) {
            this.placeFood();
            return;
          }
        }
        this.setPosition(this.foodItem, this.food.x, this.food.y);
      }

      loop(px, dt) {
        this.frameTime = (this.frameTime || 0) + dt;
        if(this.frameTime < 166) return;
        
        this.frameTime -= 166;
        
        let head = this.snake[0];
        
        if(Math.abs(this.dir.x + this.newDir.x) == 1 ||Â Math.abs(this.dir.y + this.newDir.y) == 1) {
          this.dir.copy(this.newDir);
        }
        
        let newHead = new Vector(head.x + this.dir.x, head.y + this.dir.y);
        if(newHead.x >= this.gridX) newHead.x = 0;
        if(newHead.y >= this.gridY) newHead.y = 0;
        if(newHead.x < 0) newHead.x = this.gridX - 1;
        if(newHead.y < 0) newHead.y = this.gridY - 1;
        
        this.snake.unshift(newHead);
        
        if(newHead.x == this.food.x && newHead.y == this.food.y) {
          this.grow += 1;
          this.placeFood();
        }
        
        if(this.grow <= 0) {
          this.snake.pop();
        } else {
          this.grow -= 1;
        }
        
        for(let i = 1; i < this.snake.length; i++) {
          if(this.snake[i].x == newHead.x && this.snake[i].y == newHead.y) this.setup(this.px);
        }
        
        this.updateSnake();
        
        this.scoreItem.text = this.snake.length
      }


      swipe(px, evt) {
        if (evt.direction == 4) {
          this.newDir.set(1, 0);
        } else if (evt.direction == 8) {
          this.newDir.set(0, -1);
        } else if (evt.direction == 16) {
          this.newDir.set(0, 1);
        } else if (evt.direction == 2) {
          this.newDir.set(-1, 0);
        }
      }

      keyDown(px, key) {
        if (key == "d") {
          this.newDir.set(1, 0);
        } else if (key == "a") {
          this.newDir.set(-1, 0);
        } else if (key == "w") {
          this.newDir.set(0, -1);
        } else if (key == "s") {
          this.newDir.set(0, 1);
        } else if(key == "f") {
          px.toggleFullscreen();
        }
      }
    }

    new PixiEngine(new SnakeGame());
  </script>
</body>